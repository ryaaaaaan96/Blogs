# 开发环境搭建

## 📋 概述

搭建一个高效的 STM32 开发环境是学习和开发的第一步。本文将介绍多种开发环境的搭建方法，从官方免费工具到商业IDE，帮助您选择最适合的开发方案。

## 🎯 开发环境选择

### 推荐方案对比

| 开发环境 | 价格 | 易用性 | 功能完整性 | 推荐度 |
|----------|------|--------|------------|--------|
| **STM32CubeIDE** | 免费 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Keil MDK** | 收费 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **IAR EWARM** | 收费 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **VSCode+PlatformIO** | 免费 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

## 🚀 STM32CubeIDE 安装配置（推荐）

### 为什么选择 STM32CubeIDE？

- **官方支持**：ST官方开发维护
- **完全免费**：无代码大小限制
- **功能完整**：集成编译、调试、配置工具
- **跨平台**：支持 Windows、Linux、macOS

### 安装步骤

#### 1. 下载安装包

访问 [STM32CubeIDE 官网](https://www.st.com/en/development-tools/stm32cubeide.html)

**系统要求**：
- Windows 10/11 64位
- 至少 4GB RAM（推荐 8GB）
- 2GB 可用磁盘空间

#### 2. 安装过程

```bash
# 下载后双击安装包
STM32CubeIDE-Win-1.13.2.exe

# 安装选项
- 安装路径：建议默认路径
- 组件选择：全部安装
- ST-LINK驱动：务必安装
```

#### 3. 首次配置

**工作空间设置**：
```
推荐路径：D:\STM32_Workspace
编码格式：UTF-8
行结束符：Windows (CRLF)
```

**编译器设置**：
```
工具链：GCC ARM Embedded
优化等级：-O0 (调试)/-O2 (发布)
调试信息：-g3
```

### 集成 STM32CubeMX

STM32CubeIDE 已集成 CubeMX 功能：

1. **创建项目**：File → New → STM32 Project
2. **选择芯片**：搜索目标MCU型号
3. **图形配置**：.ioc 文件进行图形化配置
4. **代码生成**：自动生成初始化代码

## 🛠️ Keil MDK 安装配置

### Keil MDK 特点

- **业界标准**：嵌入式开发经典IDE
- **性能优异**：编译优化出色
- **调试强大**：实时调试功能丰富
- **收费软件**：免费版有32KB代码限制

### 安装步骤

#### 1. 下载安装

访问 [Keil官网](https://www.keil.com/download/product/)

```bash
# 下载 MDK-ARM
MDK539.exe

# 安装注意事项
- 选择完整安装
- 安装路径不要有中文
- 需要注册账号
```

#### 2. 安装 Device Pack

```bash
# 在 Pack Installer 中安装
Keil::STM32F1xx_DFP   # F1系列器件包
Keil::STM32F4xx_DFP   # F4系列器件包
ARM::CMSIS            # CMSIS库
```

#### 3. 配置编译器

```c
// Project → Options for Target
// C/C++ 标签页设置
Define: USE_HAL_DRIVER,STM32F407xx
Include Paths: 添加头文件路径

// Debug 标签页设置
Use: ST-Link Debugger
Settings: 配置调试器参数
```

### 破解说明（仅供学习）

```bash
# 注意：仅用于学习目的，商业使用请购买正版
# 1. 安装原版软件
# 2. 使用注册机生成序列号
# 3. 激活软件
```

## 💻 Visual Studio Code 环境

### 优势特点

- **轻量级**：启动快速，资源占用少
- **可扩展**：丰富的插件生态
- **免费开源**：完全免费使用
- **跨平台**：支持多操作系统

### 安装配置步骤

#### 1. 安装 VSCode

下载：[Visual Studio Code](https://code.visualstudio.com/)

#### 2. 安装必要插件

```json
// 推荐插件列表
{
  "必装插件": [
    "PlatformIO IDE",           // 嵌入式开发平台
    "C/C++",                   // C/C++语言支持  
    "C/C++ Intellisense",      // 智能提示
    "Cortex-Debug"             // ARM调试
  ],
  "推荐插件": [
    "GitLens",                 // Git增强
    "Bracket Pair Colorizer",  // 括号配对
    "Better Comments",         // 注释增强
    "Error Lens"               // 错误显示
  ]
}
```

#### 3. 配置 PlatformIO

```ini
; platformio.ini 配置文件示例
[env:stm32f407vet6]
platform = ststm32
board = black_f407ve
framework = stm32cube

; 编译选项
build_flags = 
    -DUSE_HAL_DRIVER
    -DSTM32F407xx
    
; 调试配置  
debug_tool = stlink
debug_init_break = tbreak main
```

## 🔧 ARM GNU 工具链安装

### Windows 环境

#### 1. 下载安装包

访问 [ARM GNU Toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm)

```bash
# 下载
gcc-arm-none-eabi-10.3-2021.10-win32.exe

# 安装注意
- 添加到系统PATH
- 选择默认安装路径
```

#### 2. 验证安装

```bash
# 打开命令行验证
arm-none-eabi-gcc --version
arm-none-eabi-gdb --version
arm-none-eabi-objcopy --version
```

### Linux 环境

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install gcc-arm-none-eabi gdb-arm-none-eabi

# CentOS/RHEL
sudo yum install arm-none-eabi-gcc-cs arm-none-eabi-gdb

# 验证安装
arm-none-eabi-gcc --version
```

## 📡 调试器配置

### ST-LINK 调试器

#### 1. 驱动安装

```bash
# Windows
- STM32CubeIDE 自带驱动
- 或下载 STSW-LINK009

# Linux  
sudo apt install stlink-tools

# 验证连接
st-info --probe
```

#### 2. 连接配置

| 引脚 | STM32 | ST-LINK |
|------|-------|---------|
| **SWDIO** | PA13 | SWDIO |
| **SWCLK** | PA14 | SWCLK |
| **GND** | GND | GND |
| **VCC** | 3.3V | 3.3V |

### J-Link 调试器

#### 1. 软件安装

下载：[J-Link Software](https://www.segger.com/downloads/jlink/)

```bash
# 安装 J-Link 软件包
JLink_Windows_V794a.exe

# 验证安装
JLinkExe
```

#### 2. 配置文件

```bash
# 创建 JLinkSettings.ini
[JLINK]
Device = STM32F407VE
Interface = SWD
Speed = 4000
```

## 🎯 第一个项目创建

### STM32CubeIDE 创建项目

#### 1. 新建项目

```bash
File → New → STM32 Project
- Target Selection: STM32F407VETx
- Project Name: STM32_HelloWorld
- Location: 选择工作空间
```

#### 2. 配置引脚

```c
// 在 .ioc 文件中配置
- RCC: HSE Crystal/Ceramic Resonator
- SYS: Serial Wire (调试接口)
- GPIO: 配置LED引脚为输出
```

#### 3. 生成代码

```c
// 点击 Generate Code
// 生成的主要文件：
main.c              // 主程序
stm32f4xx_hal_conf.h // HAL库配置
stm32f4xx_it.c      // 中断服务程序
```

### 简单LED闪烁程序

```c
/* main.c */
#include "main.h"

void SystemClock_Config(void);
static void MX_GPIO_Init(void);

int main(void)
{
  HAL_Init();
  SystemClock_Config();
  MX_GPIO_Init();

  while (1)
  {
    HAL_GPIO_TogglePin(GPIOE, GPIO_PIN_3);  // LED闪烁
    HAL_Delay(500);                         // 延时500ms
  }
}

static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  
  __HAL_RCC_GPIOE_CLK_ENABLE();            // 使能GPIOE时钟
  
  GPIO_InitStruct.Pin = GPIO_PIN_3;        // 选择引脚
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP; // 推挽输出
  GPIO_InitStruct.Pull = GPIO_NOPULL;      // 无上下拉
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW; // 低速
  
  HAL_GPIO_Init(GPIOE, &GPIO_InitStruct);  // 初始化GPIO
}
```

## 🔍 调试技巧

### 断点调试

```c
// 设置断点
1. 在代码行号左侧单击
2. 程序会在断点处暂停
3. 观察变量值和寄存器状态

// 调试窗口
- Variables: 查看变量值
- Registers: 查看寄存器
- Memory: 查看内存内容
- Call Stack: 查看调用栈
```

### 实时调试

```c
// Live Expression
1. 添加需要观察的变量
2. 实时显示变量值变化
3. 无需暂停程序运行

// 示例：观察GPIO输出状态
GPIOE->ODR & GPIO_PIN_3
```

### 串口调试

```c
// 重定向 printf 到串口
#include <stdio.h>

int fputc(int ch, FILE *f)
{
  HAL_UART_Transmit(&huart1, (uint8_t *)&ch, 1, 1000);
  return ch;
}

// 使用
printf("Hello STM32!\r\n");
printf("LED State: %d\r\n", HAL_GPIO_ReadPin(GPIOE, GPIO_PIN_3));
```

## 💡 开发建议

### 环境选择建议

**初学者**：
- 首选 STM32CubeIDE
- 免费且功能完整
- 官方支持好

**有经验开发者**：
- Keil MDK（如果公司购买了正版）
- VSCode + PlatformIO（喜欢轻量级）

**团队开发**：
- 统一开发环境
- 版本控制配置
- 代码规范约定

### 常见问题解决

#### 1. 编译错误

```bash
# 路径包含中文
解决：使用英文路径

# 缺少头文件
解决：检查Include路径配置

# 链接错误
解决：检查链接脚本和库文件
```

#### 2. 下载失败

```bash
# 驱动问题
解决：重新安装ST-LINK驱动

# 连接问题  
解决：检查SWD线序和供电

# 芯片保护
解决：使用STM32CubeProg解除保护
```

#### 3. 调试问题

```bash
# 断点无效
解决：检查调试信息生成(-g3)

# 变量优化
解决：降低优化等级(-O0)

# 实时变量显示异常
解决：确保变量在当前作用域
```

---

> **环境搭建总结**：选择合适的开发环境是成功的第一步。推荐新手使用 STM32CubeIDE，功能完整且完全免费。熟练后可以根据个人喜好选择其他开发环境。
