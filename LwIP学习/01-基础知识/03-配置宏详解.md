# LwIP 配置宏详解

## 📋 概述

LwIP 通过大量的配置宏来控制协议栈的功能和行为。这些宏定义通常在 `lwipopts.h` 文件中配置，是 LwIP 灵活性的重要体现。

## 🧠 内存管理相关宏

### MEMP_OVERFLOW_CHECK

`MEMP_OVERFLOW_CHECK` 是 LwIP 用于**内存池溢出检查**的配置宏，控制内存池分配和释放时是否进行越界检测。

**使用位置**：`memp.c` 中使用

**配置选项**：
- `0`：**不做溢出检查**，最快，最省内存
- `1`：**分配和释放时检查**每个元素的前后保护区（健全性区），发现越界立即报错
- `2` 或更大：**每次分配和释放时，检查整个内存池所有元素的保护区**，极其严格和慢，适合调试内存破坏问题

**特殊说明**：
> 如果使用 `malloc` 方式的内存池，并且 `MEMP_OVERFLOW_CHECK >= 2`，会自动降级为 `1`，因为 `2` 级别和 `malloc` 方式不兼容。
>
> **建议**：实际项目中一般只在调试阶段使用，正式发布建议设为 `0` 或 `1`。

### MEMP_SANITY_CHECK

**功能**：用于定位 `mem_pool` 是否被破坏，检查内存池是否成环

**配置**：定义为 `0` 或 `1`

**使用位置**：`memp.c` 中使用

> **提示**：一般在调试时使用，用于排查内存池结构破坏问题。

### MEMP_STATS

**功能**：控制是否启用内存池统计功能

**配置**：定义为 `0` 或 `1`

**作用**：启用后可以统计各种内存池的使用情况，便于调试和优化。

### MEMP_MEM_MALLOC

**功能**：该宏定义表示是否使用 LwIP 内存堆分配策略实现内存池分配

**默认值**：`0`

**说明**：
- `0`：使用预分配的内存池数组
- `1`：使用内存堆动态分配内存池元素

### MEM_LIBC_MALLOC

**功能**：该宏定义是否使用 C 标准库自带的内存分配策略

**默认值**：`0`（不使用）

**说明**：
- `0`：使用 LwIP 自己的内存管理
- `1`：使用标准库的 `malloc/free`

### MEM_USE_POOLS

**功能**：该宏定义表示是否使用 LwIP 内存池分配策略实现内存堆的分配

**默认值**：`0`

**说明**：
- `0`：使用传统的内存堆管理
- `1`：使用内存池策略管理内存堆

## 🌐 网络接口相关宏

### LWIP_SINGLE_NETIF

**功能**：用于切换 LwIP 的单网卡/多网卡支持，影响结构体定义和相关管理逻辑

**配置选项**：
- `0`：支持多网卡（默认）
- `1`：仅支持单网卡，可节省内存和代码空间

**影响**：
- 影响 `netif` 结构体的定义
- 影响网卡管理相关的函数实现
- 单网卡模式可以减少代码复杂度和内存占用

## 🔧 功能模块控制宏

### 协议功能控制

```c
#define LWIP_IPV4                   1    // 启用 IPv4 协议
#define LWIP_IPV6                   0    // 启用 IPv6 协议
#define LWIP_TCP                    1    // 启用 TCP 协议
#define LWIP_UDP                    1    // 启用 UDP 协议
#define LWIP_ARP                    1    // 启用 ARP 协议
#define LWIP_ICMP                   1    // 启用 ICMP 协议
#define LWIP_DHCP                   0    // 启用 DHCP 客户端
#define LWIP_DNS                    0    // 启用 DNS 解析
#define LWIP_IGMP                   0    // 启用 IGMP 协议（组播）
```

### 应用层协议控制

```c
#define LWIP_HTTPD                  0    // 启用 HTTP 服务器
#define LWIP_SNTP                   0    // 启用 SNTP 客户端
#define LWIP_TFTP                   0    // 启用 TFTP 服务器
#define LWIP_MQTT                   0    // 启用 MQTT 客户端
```

## 🚀 性能调优相关宏

### TCP 参数配置

```c
#define TCP_MSS                     1460 // TCP 最大段大小
#define TCP_SND_BUF                 2920 // TCP 发送缓冲区大小
#define TCP_WND                     2920 // TCP 接收窗口大小
#define TCP_MAXRTX                  12   // TCP 最大重传次数
#define TCP_SYNMAXRTX              6    // TCP SYN 最大重传次数
```

### 内存池大小配置

```c
#define MEMP_NUM_PBUF              16   // pbuf 内存池元素个数
#define MEMP_NUM_TCP_PCB           5    // TCP PCB 内存池元素个数
#define MEMP_NUM_UDP_PCB           4    // UDP PCB 内存池元素个数
#define MEMP_NUM_TCP_SEG           16   // TCP 段内存池元素个数
#define MEMP_NUM_NETCONN           8    // NETCONN 内存池元素个数
```

## 🐛 调试相关宏

### 调试总开关

```c
#define LWIP_DEBUG                  0    // 总调试开关
```

### 各模块调试开关

```c
#define ETHARP_DEBUG               LWIP_DBG_OFF  // ARP 调试
#define IP_DEBUG                   LWIP_DBG_OFF  // IP 调试
#define TCP_DEBUG                  LWIP_DBG_OFF  // TCP 调试
#define UDP_DEBUG                  LWIP_DBG_OFF  // UDP 调试
#define PBUF_DEBUG                 LWIP_DBG_OFF  // PBUF 调试
#define MEM_DEBUG                  LWIP_DBG_OFF  // 内存调试
#define MEMP_DEBUG                 LWIP_DBG_OFF  // 内存池调试
```

### 调试级别

```c
#define LWIP_DBG_MIN_LEVEL         LWIP_DBG_LEVEL_ALL  // 最小调试级别
```

可选级别：
- `LWIP_DBG_LEVEL_ALL`：所有调试信息
- `LWIP_DBG_LEVEL_WARNING`：警告级别以上
- `LWIP_DBG_LEVEL_SERIOUS`：严重错误级别以上
- `LWIP_DBG_LEVEL_SEVERE`：致命错误级别

## ⚙️ 操作系统相关宏

### 系统模式选择

```c
#define NO_SYS                     0    // 是否无操作系统模式
```

- `0`：有操作系统模式，使用线程和信号量
- `1`：无操作系统模式，使用轮询方式

### 线程安全控制

```c
#define LWIP_TCPIP_CORE_LOCKING    1    // 是否启用内核锁
#define LWIP_NETCONN               1    // 是否启用 NETCONN API
#define LWIP_SOCKET                1    // 是否启用 Socket API
```

## 📝 配置文件模板

典型的 `lwipopts.h` 配置示例：

```c
#ifndef LWIPOPTS_H
#define LWIPOPTS_H

/* 系统配置 */
#define NO_SYS                     0
#define LWIP_SOCKET                1
#define LWIP_NETCONN               1

/* 内存配置 */
#define MEM_ALIGNMENT              4
#define MEM_SIZE                   10240
#define MEMP_NUM_PBUF              16
#define MEMP_NUM_TCP_PCB           5

/* 协议配置 */
#define LWIP_IPV4                  1
#define LWIP_IPV6                  0
#define LWIP_TCP                   1
#define LWIP_UDP                   1

/* 调试配置 */
#define LWIP_DEBUG                 0

#endif /* LWIPOPTS_H */
```

---

> **配置建议**：根据具体应用场景和硬件资源合理配置各项参数，在功能需求和资源消耗之间找到平衡点。
