# ç¡¬ä»¶æŠ½è±¡å±‚è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

LwIP çš„ç¡¬ä»¶æŠ½è±¡å±‚æ˜¯åè®®æ ˆä¸å…·ä½“ç½‘ç»œç¡¬ä»¶ä¹‹é—´çš„æ¡¥æ¢ã€‚é€šè¿‡ç»Ÿä¸€çš„æŠ½è±¡æ¥å£ï¼ŒLwIP å¯ä»¥è¿è¡Œåœ¨å„ç§ä¸åŒçš„ç½‘ç»œç¡¬ä»¶å¹³å°ä¸Šï¼Œå¦‚ä»¥å¤ªç½‘æ§åˆ¶å™¨ã€WiFi æ¨¡å—ã€PPP è°ƒåˆ¶è§£è°ƒå™¨ç­‰ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

### ç¡¬ä»¶æ— å…³æ€§
- **ç»Ÿä¸€æ¥å£**ï¼šä¸ºä¸åŒç½‘ç»œç¡¬ä»¶æä¾›ç»Ÿä¸€çš„è½¯ä»¶æ¥å£
- **å¯ç§»æ¤æ€§**ï¼šåè®®æ ˆä»£ç æ— éœ€ä¿®æ”¹å³å¯é€‚é…ä¸åŒç¡¬ä»¶
- **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„ç½‘ç»œæ¥å£ç±»å‹
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå…è®¸é’ˆå¯¹ç‰¹å®šç¡¬ä»¶è¿›è¡Œä¼˜åŒ–

### æŠ½è±¡å±‚èŒè´£
```
LwIP åè®®æ ˆ (ç¡¬ä»¶æ— å…³)
    â†• ç»Ÿä¸€æ¥å£
ç¡¬ä»¶æŠ½è±¡å±‚ (netif + ethernetif)
    â†• ç¡¬ä»¶ç›¸å…³
ç½‘ç»œç¡¬ä»¶é©±åŠ¨
    â†• å¯„å­˜å™¨æ“ä½œ
ç½‘ç»œæ§åˆ¶å™¨èŠ¯ç‰‡
```

## ğŸ—ï¸ æŠ½è±¡å±‚æ¶æ„

### åˆ†å±‚è®¾è®¡

```
+------------------------+
|      åº”ç”¨å±‚           |
+------------------------+
|    LwIP åè®®æ ˆ        |  â† ç¡¬ä»¶æ— å…³å±‚
+------------------------+
|      netif æŠ½è±¡       |  â† æŠ½è±¡æ¥å£å±‚
+------------------------+
|    ethernetif.c       |  â† ç¡¬ä»¶é€‚é…å±‚ï¼ˆç”¨æˆ·å®ç°ï¼‰
+------------------------+
|    ç¡¬ä»¶é©±åŠ¨ API       |  â† å‚å•†æä¾›çš„é©±åŠ¨åº“
+------------------------+
|    ç½‘ç»œæ§åˆ¶å™¨         |  â† ç¡¬ä»¶å±‚
+------------------------+
```

### å…³é”®ç»„ä»¶

1. **netif ç»“æ„ä½“**ï¼šç½‘ç»œæ¥å£çš„è½¯ä»¶æŠ½è±¡
2. **å›è°ƒå‡½æ•°é›†**ï¼šç¡¬ä»¶æ“ä½œçš„å‡½æ•°æŒ‡é’ˆ
3. **ethernetif.c**ï¼šç”¨æˆ·éœ€è¦å®ç°çš„ç¡¬ä»¶é€‚é…ä»£ç 
4. **ç¡¬ä»¶é©±åŠ¨**ï¼šå‚å•†æä¾›çš„åº•å±‚é©±åŠ¨åº“

## ğŸ”§ ç¡¬ä»¶æŠ½è±¡æ¥å£

### å¿…é¡»å®ç°çš„å›è°ƒå‡½æ•°

#### 1. åˆå§‹åŒ–å‡½æ•° (init)

```c
typedef err_t (*netif_init_fn)(struct netif *netif);

/* ç”¨æˆ·å®ç°ç¤ºä¾‹ */
err_t ethernetif_init(struct netif *netif)
{
  /* è®¾ç½®ç½‘å¡åŸºæœ¬ä¿¡æ¯ */
  netif->name[0] = 'e';
  netif->name[1] = 'n';
  netif->output = etharp_output;      /* IPv4 è¾“å‡ºå‡½æ•° */
  netif->linkoutput = low_level_output; /* é“¾è·¯å±‚è¾“å‡ºå‡½æ•° */
  netif->mtu = 1500;                  /* æœ€å¤§ä¼ è¾“å•å…ƒ */
  netif->flags = NETIF_FLAG_BROADCAST | NETIF_FLAG_ETHARP | NETIF_FLAG_ETHERNET;
  
  /* è®¾ç½® MAC åœ°å€ */
  netif->hwaddr_len = ETHARP_HWADDR_LEN;
  netif->hwaddr[0] = 0x02;
  netif->hwaddr[1] = 0x00;
  netif->hwaddr[2] = 0x00;
  netif->hwaddr[3] = 0x00;
  netif->hwaddr[4] = 0x00;
  netif->hwaddr[5] = 0x00;
  
  /* åˆå§‹åŒ–ç¡¬ä»¶ */
  low_level_init(netif);
  
  return ERR_OK;
}
```

#### 2. æ•°æ®å‘é€å‡½æ•° (linkoutput)

```c
typedef err_t (*netif_linkoutput_fn)(struct netif *netif, struct pbuf *p);

/* ç”¨æˆ·å®ç°ç¤ºä¾‹ */
static err_t low_level_output(struct netif *netif, struct pbuf *p)
{
  struct pbuf *q;
  uint8_t *buffer = (uint8_t *)HAL_ETH_GetTxBuffer(&heth);
  uint32_t bufferoffset = 0;
  
  /* å¤åˆ¶ pbuf é“¾è¡¨ä¸­çš„æ•°æ®åˆ°å‘é€ç¼“å†²åŒº */
  for (q = p; q != NULL; q = q->next) {
    if (bufferoffset + q->len <= ETH_TX_BUF_SIZE) {
      memcpy(buffer + bufferoffset, q->payload, q->len);
      bufferoffset += q->len;
    } else {
      return ERR_BUF;
    }
  }
  
  /* æäº¤æ•°æ®åˆ°ç¡¬ä»¶å‘é€ */
  HAL_StatusTypeDef status = HAL_ETH_Transmit(&heth, buffer, bufferoffset, 100);
  
  return (status == HAL_OK) ? ERR_OK : ERR_IF;
}
```

#### 3. æ•°æ®æ¥æ”¶å¤„ç† (input)

```c
typedef err_t (*netif_input_fn)(struct pbuf *p, struct netif *inp);

/* é€šå¸¸ä½¿ç”¨ LwIP æä¾›çš„æ ‡å‡†å‡½æ•° */
netif->input = ethernet_input;  /* ä»¥å¤ªç½‘è¾“å…¥å¤„ç† */
// æˆ–è€…
netif->input = tcpip_input;     /* çº¿ç¨‹å®‰å…¨çš„è¾“å…¥å¤„ç† */
```

### å¯é€‰çš„å›è°ƒå‡½æ•°

#### çŠ¶æ€å˜åŒ–å›è°ƒ

```c
/* ç½‘å¡çŠ¶æ€å˜åŒ–å›è°ƒ */
static void netif_status_callback(struct netif *netif)
{
  if (netif_is_up(netif)) {
    /* ç½‘å¡å¯ç”¨ */
    printf("Network interface is UP\n");
    /* å¯ä»¥åœ¨è¿™é‡Œå¯åŠ¨ DHCP ç­‰æœåŠ¡ */
  } else {
    /* ç½‘å¡ç¦ç”¨ */
    printf("Network interface is DOWN\n");
  }
}

/* é“¾è·¯çŠ¶æ€å˜åŒ–å›è°ƒ */
static void netif_link_callback(struct netif *netif)
{
  if (netif_is_link_up(netif)) {
    /* é“¾è·¯è¿æ¥ */
    printf("Network link is UP\n");
    netif_set_up(netif);
  } else {
    /* é“¾è·¯æ–­å¼€ */
    printf("Network link is DOWN\n");
    netif_set_down(netif);
  }
}

/* è®¾ç½®å›è°ƒå‡½æ•° */
netif_set_status_callback(&gnetif, netif_status_callback);
netif_set_link_callback(&gnetif, netif_link_callback);
```

## ğŸ”Œ ç¡¬ä»¶é©±åŠ¨é›†æˆ

### STM32 ä»¥å¤ªç½‘ç¤ºä¾‹

#### ç¡¬ä»¶åˆå§‹åŒ–

```c
static void low_level_init(struct netif *netif)
{
  /* GPIO é…ç½® */
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);
  
  /* ä»¥å¤ªç½‘æ§åˆ¶å™¨é…ç½® */
  heth.Instance = ETH;
  heth.Init.AutoNegotiation = ETH_AUTONEGOTIATION_ENABLE;
  heth.Init.Speed = ETH_SPEED_100M;
  heth.Init.DuplexMode = ETH_MODE_FULLDUPLEX;
  heth.Init.PhyAddress = LAN8742A_PHY_ADDRESS;
  
  /* MAC åœ°å€é…ç½® */
  heth.Init.MACAddr[0] = netif->hwaddr[0];
  heth.Init.MACAddr[1] = netif->hwaddr[1];
  heth.Init.MACAddr[2] = netif->hwaddr[2];
  heth.Init.MACAddr[3] = netif->hwaddr[3];
  heth.Init.MACAddr[4] = netif->hwaddr[4];
  heth.Init.MACAddr[5] = netif->hwaddr[5];
  
  /* æ¥æ”¶è¿‡æ»¤å™¨é…ç½® */
  heth.Init.RxMode = ETH_RXINTERRUPT_MODE;
  heth.Init.ChecksumMode = ETH_CHECKSUM_BY_HARDWARE;
  heth.Init.MediaInterface = ETH_MEDIA_INTERFACE_RMII;
  
  /* åˆå§‹åŒ–ä»¥å¤ªç½‘æ§åˆ¶å™¨ */
  if (HAL_ETH_Init(&heth) != HAL_OK) {
    Error_Handler();
  }
  
  /* å¯ç”¨æ¥æ”¶ä¸­æ–­ */
  HAL_ETH_Start(&heth);
}
```

#### ä¸­æ–­å¤„ç†

```c
/* ä»¥å¤ªç½‘ä¸­æ–­å¤„ç†å‡½æ•° */
void ETH_IRQHandler(void)
{
  HAL_ETH_IRQHandler(&heth);
}

/* æ¥æ”¶å®Œæˆå›è°ƒ */
void HAL_ETH_RxCpltCallback(ETH_HandleTypeDef *heth)
{
  /* é€šçŸ¥ç½‘ç»œä»»åŠ¡å¤„ç†æ¥æ”¶æ•°æ® */
  osSemaphoreRelease(s_xSemaphore);
}

/* ç½‘ç»œæ¥æ”¶ä»»åŠ¡ */
void ethernetif_input_thread(void *argument)
{
  struct pbuf *p;
  
  while (1) {
    /* ç­‰å¾…æ¥æ”¶ä¿¡å· */
    osSemaphoreAcquire(s_xSemaphore, osWaitForever);
    
    /* å¤„ç†æ‰€æœ‰æ¥æ”¶çš„æ•°æ®åŒ… */
    do {
      p = low_level_input(&gnetif);
      if (p != NULL) {
        if (gnetif.input(p, &gnetif) != ERR_OK) {
          pbuf_free(p);
        }
      }
    } while (p != NULL);
  }
}
```

### WiFi æ¨¡å—ç¤ºä¾‹

#### ESP32 WiFi æŠ½è±¡

```c
/* WiFi ç¡¬ä»¶åˆå§‹åŒ– */
static void wifi_low_level_init(struct netif *netif)
{
  /* WiFi é…ç½® */
  wifi_config_t wifi_config = {
    .sta = {
      .ssid = "your_ssid",
      .password = "your_password",
    },
  };
  
  /* åˆå§‹åŒ– WiFi */
  esp_wifi_init(&cfg);
  esp_wifi_set_mode(WIFI_MODE_STA);
  esp_wifi_set_config(ESP_IF_WIFI_STA, &wifi_config);
  esp_wifi_start();
  
  /* è¿æ¥åˆ° AP */
  esp_wifi_connect();
}

/* WiFi æ•°æ®å‘é€ */
static err_t wifi_low_level_output(struct netif *netif, struct pbuf *p)
{
  /* å°† pbuf è½¬æ¢ä¸º ESP32 æ ¼å¼ */
  esp_err_t ret = esp_wifi_internal_tx(ESP_IF_WIFI_STA, p->payload, p->len);
  
  return (ret == ESP_OK) ? ERR_OK : ERR_IF;
}

/* WiFi æ•°æ®æ¥æ”¶å¤„ç† */
static void wifi_rx_handler(void *buffer, uint16_t len, void *eb)
{
  struct pbuf *p;
  
  /* åˆ›å»º pbuf å¹¶å¤åˆ¶æ•°æ® */
  p = pbuf_alloc(PBUF_RAW, len, PBUF_POOL);
  if (p != NULL) {
    memcpy(p->payload, buffer, len);
    
    /* ä¼ é€’ç»™åè®®æ ˆ */
    if (netif->input(p, netif) != ERR_OK) {
      pbuf_free(p);
    }
  }
  
  /* é‡Šæ”¾åº•å±‚ç¼“å†²åŒº */
  esp_wifi_internal_free_rx_buffer(eb);
}
```

## ğŸ› ï¸ ä¸åŒç¡¬ä»¶ç±»å‹çš„æŠ½è±¡

### ä»¥å¤ªç½‘æ¥å£

**ç‰¹ç‚¹**ï¼š
- é«˜é€Ÿã€å¯é çš„æœ‰çº¿è¿æ¥
- æ”¯æŒå…¨åŒå·¥é€šä¿¡
- ç¡¬ä»¶æ ¡éªŒå’Œå¸è½½
- DMA ä¼ è¾“æ”¯æŒ

**å®ç°è¦ç‚¹**ï¼š
```c
/* ä»¥å¤ªç½‘ç‰¹æœ‰é…ç½® */
netif->flags = NETIF_FLAG_BROADCAST | 
               NETIF_FLAG_ETHARP | 
               NETIF_FLAG_ETHERNET |
               NETIF_FLAG_IGMP;

/* å¤§ MTU æ”¯æŒ */
netif->mtu = 1500;

/* ç¡¬ä»¶æ ¡éªŒå’Œ */
#if CHECKSUM_BY_HARDWARE
netif->chksum_flags = NETIF_CHECKSUM_ENABLE_ALL;
#endif
```

### WiFi æ¥å£

**ç‰¹ç‚¹**ï¼š
- æ— çº¿è¿æ¥ï¼Œä¿¡å·å¼ºåº¦å˜åŒ–
- éœ€è¦å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
- åŠŸè€—ç®¡ç†é‡è¦
- å®‰å…¨è®¤è¯å¤æ‚

**å®ç°è¦ç‚¹**ï¼š
```c
/* WiFi ç‰¹æœ‰é…ç½® */
netif->flags = NETIF_FLAG_BROADCAST | 
               NETIF_FLAG_ETHARP |
               NETIF_FLAG_ETHERNET;

/* è¾ƒå°çš„ MTU */
netif->mtu = 1500;  /* æˆ–æ›´å°ï¼Œå–å†³äºå…·ä½“å®ç° */

/* å¤„ç†è¿æ¥çŠ¶æ€ */
static void wifi_status_changed(wifi_event_t event)
{
  switch (event) {
    case WIFI_EVENT_STA_CONNECTED:
      netif_set_link_up(&wifi_netif);
      break;
    case WIFI_EVENT_STA_DISCONNECTED:
      netif_set_link_down(&wifi_netif);
      break;
  }
}
```

### PPP æ¥å£

**ç‰¹ç‚¹**ï¼š
- ç‚¹å¯¹ç‚¹è¿æ¥
- éœ€è¦æ‹¨å·å»ºç«‹è¿æ¥
- æ”¯æŒè®¤è¯åè®®
- å¯å˜çš„è¿æ¥é€Ÿç‡

**å®ç°è¦ç‚¹**ï¼š
```c
/* PPP ç‰¹æœ‰é…ç½® */
netif->flags = NETIF_FLAG_POINTTOPOINT;
netif->mtu = 1500;  /* å¯åå•† */

/* PPP ç‰¹æ®Šå¤„ç† */
netif->output = ppp_output;
netif->linkoutput = ppp_low_level_output;
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### DMA ä¼˜åŒ–

```c
/* ä½¿ç”¨ DMA è¿›è¡Œé›¶æ‹·è´ä¼ è¾“ */
static err_t low_level_output_dma(struct netif *netif, struct pbuf *p)
{
  /* æ£€æŸ¥ pbuf æ˜¯å¦è¿ç»­ */
  if (p->next == NULL && pbuf_is_contiguous(p)) {
    /* ç›´æ¥ä½¿ç”¨ pbuf ç¼“å†²åŒºè¿›è¡Œ DMA ä¼ è¾“ */
    HAL_ETH_Transmit_DMA(&heth, p->payload, p->len);
  } else {
    /* éœ€è¦å¤åˆ¶åˆ°è¿ç»­ç¼“å†²åŒº */
    uint8_t *buffer = get_tx_buffer();
    pbuf_copy_partial(p, buffer, p->tot_len, 0);
    HAL_ETH_Transmit_DMA(&heth, buffer, p->tot_len);
  }
  
  return ERR_OK;
}
```

### ä¸­æ–­ä¼˜åŒ–

```c
/* æœ€å°åŒ–ä¸­æ–­å¤„ç†æ—¶é—´ */
void ETH_IRQHandler(void)
{
  uint32_t status = ETH->DMASR;
  
  if (status & ETH_DMASR_RS) {
    /* æ¥æ”¶ä¸­æ–­ï¼šåªé€šçŸ¥å¤„ç†ä»»åŠ¡ */
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    xSemaphoreGiveFromISR(rx_semaphore, &xHigherPriorityTaskWoken);
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
  }
  
  if (status & ETH_DMASR_TS) {
    /* å‘é€å®Œæˆä¸­æ–­ï¼šé‡Šæ”¾å‘é€ç¼“å†²åŒº */
    release_tx_buffer();
  }
  
  /* æ¸…é™¤ä¸­æ–­æ ‡å¿— */
  ETH->DMASR = status;
}
```

### ç¼“å†²åŒºç®¡ç†

```c
/* ç¯å½¢ç¼“å†²åŒºç®¡ç† */
typedef struct {
  uint8_t *buffers[TX_BUFFER_COUNT];
  uint32_t head;
  uint32_t tail;
  uint32_t count;
} tx_buffer_pool_t;

static tx_buffer_pool_t tx_pool;

static uint8_t *get_tx_buffer(void)
{
  if (tx_pool.count > 0) {
    uint8_t *buffer = tx_pool.buffers[tx_pool.tail];
    tx_pool.tail = (tx_pool.tail + 1) % TX_BUFFER_COUNT;
    tx_pool.count--;
    return buffer;
  }
  return NULL;
}

static void release_tx_buffer(uint8_t *buffer)
{
  if (tx_pool.count < TX_BUFFER_COUNT) {
    tx_pool.buffers[tx_pool.head] = buffer;
    tx_pool.head = (tx_pool.head + 1) % TX_BUFFER_COUNT;
    tx_pool.count++;
  }
}
```

## ğŸ¯ ç§»æ¤æœ€ä½³å®è·µ

### 1. åˆ†å±‚å®ç°

```c
/* æ¸…æ™°çš„åˆ†å±‚ç»“æ„ */
// åº”ç”¨å±‚
app_send_data() â†’ 

// LwIP API å±‚
lwip_send() â†’ 

// åè®®æ ˆå±‚
tcp_output() â†’ 

// æŠ½è±¡æ¥å£å±‚
netif->linkoutput() â†’ 

// ç¡¬ä»¶é€‚é…å±‚
low_level_output() â†’ 

// ç¡¬ä»¶é©±åŠ¨å±‚
HAL_ETH_Transmit()
```

### 2. é”™è¯¯å¤„ç†

```c
/* å®Œå–„çš„é”™è¯¯å¤„ç† */
static err_t low_level_output(struct netif *netif, struct pbuf *p)
{
  /* å‚æ•°æ£€æŸ¥ */
  if (p == NULL || p->tot_len == 0) {
    return ERR_ARG;
  }
  
  /* ç¡¬ä»¶çŠ¶æ€æ£€æŸ¥ */
  if (!is_link_up()) {
    return ERR_IF;
  }
  
  /* ç¼“å†²åŒºæ£€æŸ¥ */
  if (get_tx_buffer() == NULL) {
    return ERR_MEM;
  }
  
  /* æ‰§è¡Œå‘é€ */
  HAL_StatusTypeDef status = HAL_ETH_Transmit(&heth, buffer, len, 1000);
  if (status != HAL_OK) {
    release_tx_buffer(buffer);
    return ERR_IF;
  }
  
  return ERR_OK;
}
```

### 3. è°ƒè¯•æ”¯æŒ

```c
/* è°ƒè¯•ä¿¡æ¯è¾“å‡º */
#define NETIF_DEBUG_ENABLED 1

#if NETIF_DEBUG_ENABLED
#define NETIF_DEBUG(fmt, ...) printf("NETIF: " fmt "\n", ##__VA_ARGS__)
#else
#define NETIF_DEBUG(fmt, ...)
#endif

/* ç»Ÿè®¡ä¿¡æ¯æ”¶é›† */
static struct netif_stats {
  uint32_t tx_packets;
  uint32_t rx_packets;
  uint32_t tx_errors;
  uint32_t rx_errors;
} netif_stats;

static void update_tx_stats(err_t result)
{
  if (result == ERR_OK) {
    netif_stats.tx_packets++;
  } else {
    netif_stats.tx_errors++;
  }
}
```

---

> **æ€»ç»“**ï¼šç¡¬ä»¶æŠ½è±¡å±‚æ˜¯ LwIP å¯ç§»æ¤æ€§çš„å…³é”®ã€‚é€šè¿‡æ¸…æ™°çš„æ¥å£è®¾è®¡å’Œåˆ†å±‚æ¶æ„ï¼ŒLwIP èƒ½å¤Ÿé€‚åº”å„ç§ä¸åŒçš„ç½‘ç»œç¡¬ä»¶å¹³å°ï¼ŒåŒæ—¶ä¸ºç”¨æˆ·æä¾›äº†çµæ´»çš„ä¼˜åŒ–ç©ºé—´ã€‚
