# 资源

资源管理是嵌入式系统中的一个核心问题，尤其是在内存和处理器时间受限的环境中。

## 规则 22.1：代码不应包含可能导致资源泄漏的路径

- 必须

如果程序分配了资源（如内存、文件句柄、锁），那么必须确保在所有可能的执行路径上，这些资源最终都能被正确释放。未能释放资源会导致资源泄漏，最终可能导致系统崩溃。

## 规则 22.2：`free()` 函数的参数应是动态分配的内存

- 必须

传递给 `free()` 的指针必须是通过 `malloc`, `calloc`, `realloc` 等函数获得的，或者是空指针。将一个无效的指针（如指向栈的指针、已释放的指针、未初始化的指针）传递给 `free()` 会导致未定义行为。

## 规则 22.3：动态分配的内存应只被释放一次

- 必须

同一块动态分配的内存不能被释放超过一次。重复释放（double free）会导致堆损坏，引发不可预测的程序行为。

## 规则 22.4：文件流应在使用后被关闭

- 必须

如果程序通过 `fopen` 等函数打开了一个文件流，那么在文件使用完毕后，必须通过 `fclose` 将其关闭。这可以确保所有缓冲的数据被写回文件，并释放与文件流相关的系统资源。

## 规则 22.5：文件指针在使用前应检查是否为 `NULL`

- 必须

`fopen` 等文件打开函数在失败时会返回一个空指针。在使用文件指针之前，必须检查它是否为 `NULL`，以防止对无效指针的解引用。

## 规则 22.6：`fgetpos`, `fsetpos`, `rewind` 的返回值应被检查

- 必须

用于文件定位的函数（如 `fseek`, `fsetpos`）在成功时返回0，失败时返回非零值。必须检查这些函数的返回值，以确保文件定位操作成功完成。

## 规则 22.7：`remove` 和 `rename` 的返回值应被检查

- 必须

文件操作函数 `remove`（删除文件）和 `rename`（重命名文件）在失败时会返回非零值。应检查它们的返回值以确认操作是否成功。

## 规则 22.8：标准库函数的返回值应被检查

- 建议

许多标准库函数通过返回值来报告错误。应检查这些返回值，以确保函数调用成功，并对可能发生的错误进行适当处理。

## 规则 22.9：`EOF` 宏不应与字符类型直接比较

- 必须

`EOF` 是一个表示文件结束的整型常量，其值通常为-1。`fgetc` 等函数在返回 `EOF` 或一个有效字符时，返回的是一个 `int`。将这个返回值直接赋给一个 `char` 可能会导致 `EOF` 与某个有效字符（如0xFF）混淆。应使用 `int` 类型的变量来接收这些函数的返回值。

## 规则 22.10：`realloc` 的返回值不应直接赋给原指针

- 必须

`realloc` 在重新分配内存失败时会返回 `NULL`，但原始的内存块不会被释放。如果将 `realloc` 的返回值直接赋给原来的指针（如 `ptr = realloc(ptr, new_size);`），一旦分配失败，就会丢失指向原始内存的唯一指针，导致内存泄漏。正确的做法是使用一个临时指针来接收 `realloc` 的返回值。
